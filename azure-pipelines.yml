trigger:
- main

pool:
  vmImage: ubuntu-latest

jobs:

  - job: build_image
    displayName: Build Docker image

    container: mcr.microsoft.com/dotnet/sdk:6.0-jammy # This has PowerShell

    variables:
      DOCKER_BUILDKIT: 1

    steps:
    - task: PowerShell@2
      inputs:
        filePath: "scripts/Test-ChangesMadeInPath.ps1"
        arguments: >-
          -authorisation "Bearer $(system.accesstoken)" 
          -pathFilter "build/containers" 
          -buildId $(Build.BuildId)
          -collectionUri "$(System.CollectionUri)"
          -project "$(System.TeamProject)"
      env:
        SYSTEM_ACCESSTOKEN: $(system.accesstoken)

    - task: DockerInstaller@0
      displayName: Docker Installer
      condition: eq(variables['filesUpdated'], 'True')
      inputs:
        dockerVersion: 20.10.17
        releaseType: stable

    - script: |
        docker info
      displayName: 'Docker: info'
      condition: eq(variables['filesUpdated'], 'True')

    - task: Docker@2
      displayName: 'Docker: login'
      condition: eq(variables['filesUpdated'], 'True')
      inputs:
        command: login
        containerRegistry: 'GitHub Packages'

    - script: |
        docker pull ghcr.io/flcdrg/azure-pipelines-container-jobs:latest
      displayName: 'Docker: pull'
      condition: eq(variables['filesUpdated'], 'True')

    - script: |
        docker inspect ghcr.io/flcdrg/azure-pipelines-container-jobs:latest
      displayName: 'Docker: inspect'
      condition: eq(variables['filesUpdated'], 'True')

    - task: Docker@2
      displayName: 'Docker: build'
      condition: eq(variables['filesUpdated'], 'True')
      inputs:
        containerRegistry: 'GitHub Packages'
        repository: 'flcdrg/azure-pipelines-container-jobs'
        command: 'build'
        buildContext: 'build/containers'
        Dockerfile: 'build/containers/Dockerfile'
        arguments: '--build-arg BUILDKIT_INLINE_CACHE=1 --cache-from ghcr.io/flcdrg/azure-pipelines-container-jobs:latest'
        tags: 'latest'

    - task: Docker@2
      displayName: 'Docker: push'
      condition: eq(variables['filesUpdated'], 'True')
      inputs:
        containerRegistry: 'GitHub Packages'
        repository: 'flcdrg/azure-pipelines-container-jobs'
        command: 'push'
        tags: 'latest'

  - job: use_image
    displayName: Use image
    dependsOn: build_image
    container:
      image: ghcr.io/flcdrg/azure-pipelines-container-jobs:latest
      endpoint: 'GitHub Packages'

    steps:
      - task: DockerInstaller@0
        displayName: Docker Installer
        inputs:
          dockerVersion: 20.10.17
          releaseType: stable

      - script: |
          dotnet --info
          docker info
        displayName: Info